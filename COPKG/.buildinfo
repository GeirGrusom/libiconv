@import "version.inc";

#product-info  {
    product-name: "libiconv";
    version: "1.13.1";
    original-source-location: "http://ftp.gnu.org/pub/gnu/libiconv/libiconv-1.13.1.tar.gz";
    original-source-website: "http://www.gnu.org/software/libiconv/";
    license: "LGPL, exe under GPL";
    packager: "Eric Schultz";
}

test {
    default : false;
    uses: release;
    build-command: @"
	    rem ";
};

package {
    
    default : false;
    uses : sign;
    
    targets: { 
        @"copkg\libiconv[vc10]-${package-version}-x86.msi",
        @"copkg\libiconv-dev[vc10]-${package-version}-x86.msi",
        @"copkg\libiconv-dev-common-${package-version}-any.msi",
        @"copkg\libiconv[vc10]-${package-version}-x64.msi",
        @"copkg\libiconv-dev[vc10]-${package-version}-x64.msi"
    };
    
    build-command : @"
        REM THERE IS SOME GOOFY STUFF IN HERE TO WORK AROUND A COUPLE BUGS IN AUTOPACKAGE.
        REM FIXES COMING SOON...
        cd COPKG
        coapp add-feed %cd%\
        coapp --force-scan list 
        autopackage libiconv-dev-common.autopkg || goto failed
        coapp --force-scan list 
        autopackage libiconv[vc10]-x86.autopkg libiconv-dev[vc10]-x86.autopkg || goto failed
        coapp --force-scan list 
        autopackage libiconv[vc10]-x64.autopkg libiconv-dev[vc10]-x64.autopkg || goto failed
        coapp --force-scan list 
        coapp remove-feed %cd%\
        ptk update-version
    ";

	clean-command: @"del COPKG\*.msi COPKG\*.wixpdb";
	
};


update-version {
    default : false;
    
    build-command : @"
        REM auto-increment version.inc file...
        
        cd COPKG
        setlocal EnableDelayedExpansion
        for /F ""tokens=4,5,6,7  delims=.; "" %%v in (version.inc) do (
            set /a build=%%y + 1
            set VERSTRING=#define { package-version: %%v.%%w.%%x.!build!; }
        )
        echo !VERSTRING! > version.inc
    ";
}

release {
    set: BuildCfg="Release";
    uses: x86;
    uses: x64;
};

sign {
    default : false;
    uses: release;
    build-command: @"simplesigner.exe --nologo --sign Release\x64\**.dll Release\x86\**.dll";
};


mingw {
	compiler: "mingw";

	default: false;
 
    targets: { "bin\libcharset-1.dll",
			   "lib\.libs\libiconv-2.dll"};
		//	   "src\iconv_no_i18n.exe"} ;
            // a comma seperated list of the binary files that are output 
            // that are of significance
 
    build-command: @"sh './configure'
    make
	copy lib\.libs\libiconv.dll.a lib\.libs\iconv.lib
    ";
            // either a single command line, or a batch script 
            // that has the commands to build the targets listed above.
 
    clean-command: @"make clean
    rm Makefile
    rm config.log
    rm config.h
    rm libtool
    rm stamp-h1
    rm config.status
    rm lib/Makefile
    rm srclib/Makefile
    rm src/Makefile
    rm po/Makefile.in
    rm man/Makefile
    rm tests/Makefile
    rm include/iconv.h
    rm include/iconv.h.inst
    rm lib/stamp-h2
    rm po/POTFILES
    rm po/Makefile
    rm libcharset/config.status
    rm libcharset/Makefile
    rm libcharset/lib/Makefile
    rm libcharset/include/localcharset.h
    rm libcharset/include/localcharset.h.inst
    rm libcharset/libtool
    rm libcharset/config.log
    rm preload/config.status
	rm preload/config.log
    rm preload/Makefile
    rm preload/libtool
    rm lib/config.h
    rm libcharset/config.h
    rm libcharset/include/libcharset.h
    rm po/stamp-po
	rm lib/.libs/iconv.lib
    ";
}

x86 {
    compiler: vc10;
    platform: x86;

 
    targets: {
        "Release\x86\libiconv.lib",
        "Release\x86\libiconv.dll"
    };


    build-command: @"
        copy config.h.vs.in config.h
        copy libcharset\include\localcharset.h.buildvs.in libcharset\include\localcharset.h
        copy include\iconv.h.buildvs.in include\iconv.h
        msbuild /p:Platform=win32 /p:Configuration=Release COPKG\libiconv\libiconv.sln
        rem copy Release\x86\libiconv.lib Release\x86\libiconv.dll.a 
    ";
 
    clean-command: @"
        del config.h
        del include\iconv.h
        del libcharset\include\localcharset.h
        rmdir Release /S /Q
        rmdir COPKG\libiconv\ipch /S /Q
		rmdir COPKG\libiconv\Release /S /Q
        pushd COPKG
        del /S /Q /A - *.sdf *.suo *.user *.exe *.pdb > NUL 2> NUL
        popd
    ";
}

x64 {
    compiler: vc10;
    platform: x64;

 
    targets: {
        "Release\x64\libiconv.lib",
        "Release\x64\libiconv.dll"
    };


    build-command: @"
        copy config.h.vs.in config.h
        copy libcharset\include\localcharset.h.buildvs.in libcharset\include\localcharset.h
        copy include\iconv.h.buildvs.in include\iconv.h
        msbuild /p:Platform=x64 /p:Configuration=Release COPKG\libiconv\libiconv.sln
        copy Release\x64\libiconv.lib Release\x64\libiconv.dll.a
    ";
 
    clean-command: @"
        del config.h
        del include\iconv.h
        del libcharset\include\localcharset.h
        rmdir Release /S /Q
        rmdir COPKG\libiconv\ipch /S /Q
		rmdir COPKG\libiconv\Release /S /Q

        pushd COPKG
        del /S /Q /A - *.sdf *.suo *.user *.exe *.pdb > NUL 2> NUL
        popd
    ";
}

